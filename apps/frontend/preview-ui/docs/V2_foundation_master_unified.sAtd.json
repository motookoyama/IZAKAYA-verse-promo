{
  "spec_id": "izakaya_v2_foundation",
  "title": "IZAKAYA V2 Card Foundation Spec (Phase 1, Unified)",
  "version": "0.09",
  "updated": "2025-09-04",
  "scope": "phase1-ui-only",
  "formats": {
    "png": {
      "chunks": [
        "tEXt",
        "iTXt",
        "zTXt"
      ],
      "encoding": "utf-8",
      "compression": {
        "iTXt": {
          "compressionFlag": [
            0,
            1
          ],
          "compressionMethod": [
            0
          ]
        },
        "zTXt": {
          "compressionMethod": [
            0
          ],
          "note": "deflate"
        }
      },
      "extraction_steps": "Extract PNG chunks (tEXt/iTXt/zTXt). If multiple 'chara' keys exist, keep the last. Decode according to type. Normalize to UTF-8 text. Validate JSON parse.",
      "fallbacks": "If zTXt deflate unsupported, show error E_PNG_EXTRACT and offer JSON/.sAtd import."
    },
    "json": {
      "charset": "utf-8",
      "root": "object"
    },
    "sAtd": {
      "charset": "utf-8",
      "root": "object",
      "note": "json-compatible text"
    }
  },
  "normalization": {
    "name_priority": [
      "name",
      "character",
      "title",
      "data.name"
    ],
    "first_mes_priority": [
      "data.first_mes",
      "spec.first_mes",
      "card.first_mes",
      "first_mes"
    ],
    "behavior_priority": [
      "description",
      "system_prompt",
      "behavior",
      "data.description"
    ],
    "links_priority": [
      "links",
      "data.links"
    ],
    "icon_priority": [
      "icon",
      "meta.icon"
    ],
    "defaults": {
      "icon": "ğŸƒ",
      "links": []
    }
  },
  "api": {
    "list": {
      "method": "GET",
      "path": "/api/v2/cards",
      "response": {
        "shape": "items[] or []",
        "required_keys": [
          "id",
          "name"
        ]
      }
    },
    "detail": {
      "method": "GET",
      "path": "/api/v2/cards/{id}",
      "response": {
        "shape": "object",
        "note": "normalizable to internal schema"
      }
    },
    "save": {
      "method": "PUT",
      "path": "/api/v2/cards/{id}",
      "body_required": [
        "id",
        "name"
      ],
      "alt": {
        "method": "POST",
        "path": "/api/v2/cards"
      }
    },
    "reload": {
      "required": false,
      "path": null,
      "note": "not required, UI reloads from memory"
    },
    "cors": {
      "allow_origins": [
        "http://localhost:5173"
      ],
      "note": "expand as needed"
    }
  },
  "internal_schema": {
    "type": "json-schema-draft-2020-12",
    "schema": {
      "$schema": "https://json-schema.org/draft/2020-12/schema",
      "title": "IZAKAYA V2 Internal Schema",
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "first_mes": {
          "type": "string"
        },
        "behavior": {
          "type": "string"
        },
        "links": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "title": {
                "type": "string"
              },
              "url": {
                "type": "string",
                "format": "uri"
              }
            },
            "required": [
              "title",
              "url"
            ]
          }
        },
        "icon": {
          "type": "string"
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "required": [
      "id",
      "name"
    ],
    "fields": {
      "id": "string",
      "name": "string",
      "first_mes": "string",
      "behavior": "string",
      "links": "array[{title,url}]",
      "icon": "string"
    }
  },
  "validation": {
    "rules": [
      "required fields present",
      "types match",
      "links[] items valid"
    ],
    "errors": [
      {
        "code": "E_PARSE",
        "message": "Failed to parse JSON"
      },
      {
        "code": "E_REQUIRED",
        "message": "Required field missing"
      },
      {
        "code": "E_PNG_EXTRACT",
        "message": "Failed to extract/deflate PNG embedded JSON"
      }
    ],
    "ui_guidance": "Show error messages in UI; guide user to import JSON/.sAtd if PNG fails"
  },
  "security": {
    "forbidden": [
      "password",
      "token",
      "api_key"
    ],
    "handling": "Keep secrets in .env/Secrets; never in card text."
  },
  "i18n": {
    "jp_ui_mode": {
      "phase1": "display only",
      "future": "translation hook"
    }
  },
  "golden_master": {
    "gm1_json": {
      "spec": "chara_card_v2",
      "spec_version": "2.0",
      "data": {
        "name": "TestChar",
        "description": "Minimal character",
        "first_mes": "Hello.",
        "mes_example": "<START>\n{{user}}: hi\n{{char}}: hello"
      }
    },
    "gm2_satd": {
      "spec": "chara_card_v2",
      "spec_version": "2.0",
      "data": {
        "name": "TestChar",
        "description": "Minimal character",
        "first_mes": "Hello.",
        "mes_example": "<START>\n{{user}}: hi\n{{char}}: hello"
      }
    },
    "gm3_png": "PNG with single iTXt chunk 'chara', compressionFlag=0, UTF-8 JSON string identical to gm1_json.",
    "normalization_expectation": "All 3 normalize to identical internal object"
  },
  "acceptance": {
    "import": [
      "json",
      ".sAtd",
      "png"
    ],
    "display": [
      "name",
      "first_mes",
      "behavior",
      "links",
      "icon"
    ],
    "save": [
      "PUT/POST success",
      "re-fetch equals saved"
    ],
    "failure_cases": [
      "broken json",
      "png deflate unsupported",
      "missing required"
    ]
  },
  "glossary": {
    "first_mes": "åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã«ã‚­ãƒ£ãƒ©ãŒç™ºã™ã‚‹æ–‡è¨€",
    "behavior": "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ€§æ ¼ãƒ»è¡Œå‹•æŒ‡é‡ã€‚é€šå¸¸ description/system_prompt ã‚’å«ã‚€",
    "v2/v3": "SillyTavernã®ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚v2ã¨v3ã¯äº’æ›è¨­è¨ˆ"
  },
  "appendix": {
    "examples": [
      {
        "list_response": {
          "items": [
            {
              "id": "c1",
              "name": "Alice"
            }
          ]
        }
      },
      {
        "detail_response": {
          "id": "c1",
          "name": "Alice",
          "first_mes": "Hi",
          "behavior": "Friendly"
        }
      },
      {
        "save_request": {
          "id": "c1",
          "name": "Alice"
        }
      }
    ]
  },
  "codex_faq": {
    "q1": {
      "question": "ãªãœ PNG ã§ SillyTavern ãŒèª­ã¿è¾¼ã‚ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã‹ï¼Ÿ",
      "answer": "iTXt ãƒãƒ£ãƒ³ã‚¯ã®ä»•æ§˜é•åï¼ˆåœ§ç¸®ãƒ•ãƒ©ã‚°ã‚„ BOMï¼‰ãŒåŸå› ã€‚å¿…ãš compressionFlag=0, UTF-8 BOMãªã— ã§æ›¸ãè¾¼ã‚€ã“ã¨ã€‚"
    },
    "q2": {
      "question": "name ã¨ title ãŒä¸¡æ–¹ã‚ã‚‹ã¨ãã¯ï¼Ÿ",
      "answer": "æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ name > character > title > data.name ã®é †ã§æ±ºå®šã™ã‚‹ã€‚"
    },
    "q3": {
      "question": "ä¿å­˜ API ã§ POST ã¨ PUT ã¯ã©ã†ä½¿ã„åˆ†ã‘ã‚‹ï¼Ÿ",
      "answer": "æ–°è¦ã¯ POST /api/v2/cards, æ›´æ–°ã¯ PUT /api/v2/cards/{id}ã€‚é‡è¤‡ id ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã€‚"
    },
    "q4": {
      "question": "v2 ã¨ v3 ã®é•ã„ã¯ï¼Ÿ",
      "answer": "æ§‹é€ ã¯äº’æ›ã€‚v3 ã«ã¯è¿½åŠ ã‚­ãƒ¼ãŒã‚ã‚‹ãŒã€æœ¬ä»•æ§˜ã§ã¯ v2 ã‚’æœ€ä½é™ã¨ã—ã¦äº’æ›å‡¦ç†ã™ã‚‹ã€‚"
    },
    "q5": {
      "question": "æ¤œè¨¼å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯ï¼Ÿ",
      "answer": "JSON parseå¤±æ•—=E_PARSEã€å¿…é ˆæ¬ è½=E_REQUIREDã€PNGæŠ½å‡ºå¤±æ•—=E_PNG_EXTRACTã€‚"
    }
  }
}

