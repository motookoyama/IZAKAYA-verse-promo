# IZAKAYA / YGGDRASIL – HEARTBEAT PROTOCOL.sAtd.md
**目的（Purpose）**  
フロントエンドとバックエンド（BFF）が「稼働している」だけではなく、  
**実際に相互通信が成立していること** を、常時・自動的・視覚的に確認するための監視プロトコル。

過去に発生した以下の問題を根絶する：  
- サーバーは立っているが、ルートが間違っていて返事が来ない  
- フロントが問い合わせていない（無送信）  
- 返答が来ても UI に届かず、ユーザーが気付けない  
- 片通行の状態でも異常表示されない  
- モックやLLM応答が返らず、原因が特定できない

このプロトコルは **最低限の生命維持装置（ライフゲージ）** として全アプリに実装する。

---

## ✅ 1. HEARTBEAT API（BFF側）
BFF は必ずこのエンドポイントを持つ：

**`GET /health/ping`**  
レスポンス例：

```json
{
  "ok": true,
  "timestamp": "2025-10-29T13:20:55Z",
  "version": "bff-1.4.2",
  "uptime": "15234s"
}
```

**必須条件**

* `ok: true` を返す
* HTTP 200
* CORS 正常
* ルーティングが機能していることを保証

これにより「BFFが立っている」ではなく
**“BFFが応答可能である”** ことを証明する。

---

## ✅ 2. フロントエンド側（Heartbeat Watcher）

フロントは以下を実装する：

```ts
setInterval(checkHeartbeat, 10000); // 10秒ごと
```

`checkHeartbeat()` の動作：

1. `/health/ping` を fetch
2. 成功 → UI を「🟢 通信：正常」
3. 200でない or timeout → 「🔴 通信：不通」へ
4. 状態は画面に常時表示

例：

```
🟢 通信：正常（3秒前応答）
🔴 通信：不通（チャット送信を停止）
```

**サイレントフェイルを禁止する。**

---

## ✅ 3. チャットやウォレット通信も監視対象

以下全ての API が対象：

* POST /chat/v1
* GET /wallet/balance
* POST /wallet/redeem
* POST /wallet/consume

失敗した場合は必ず UI 通知：

```
「サーバーが応答していません」
「BFFと通信できません」
```

※ 無言で失敗・コンソールだけにエラー は禁止。

---

## ✅ 4. UI に「通信インジケータ」を表示

UIは必ず通信状態をユーザーが見える場所に出す。

| 状態    | 表示        | 意味          |
| ----- | --------- | ----------- |
| 🟢 正常 | BFF に応答あり | 送信可能        |
| ⚠️ 遅延 | 応答が遅い     | 遅延するが送信可能   |
| 🔴 不通 | 応答なし      | チャット送信停止、警告 |

**チャットは不通状態では送信できない UI にする。**

---

## ✅ 5. 開発モードでは「デバッグパネル」

`/dev` または UI 内の管理タブに以下を可視化：

| 表示項目                 |
| -------------------- |
| BFF URL              |
| 最終応答時刻               |
| Round Trip Time (ms) |
| API Provider / Model |
| APIキー読み込み状態          |
| 最後に成功した API          |

例（UI）：

```
BFF: http://localhost:3000
通信: 🟢 正常（58ms）
APIプロバイダ: GEMINI / gemini-pro
```

**ログを探す必要がない** 設計。

---

## ✅ 6. DoD（完了条件）

この HEARTBEAT プロトコルが「動作している」と認定される条件：

* ✅ `/health/ping` が常に 200 を返す
* ✅ UI に通信ランプが常時表示
* ✅ 通信異常時に UI が警告
* ✅ 異常時はチャット送信を停止
* ✅ 開発者はログを探さず原因を把握できる

---

## ✅ 7. 適用範囲

* IZAKAYA verse 全バージョン
* ユグドラシル本編・外伝
* Lite Preview / 本番サーバー
* Mini BFF / Full BFF / Cloud BFF
* ローカル開発・Docker・クラウド環境

---

## ✅ 結語

通信が確立していなければ、
**LLMもチャットも全て死体と同じ**。

この HEARTBEAT PROTOCOL は
「糸電話が繋がっているかを常に確認する」ための生命線であり、
全プロジェクトの最初のファイルとして配置する。

---

**このファイル名：**
`HEARTBEAT PROTOCOL.sAtd.md`
`docs/` または `infra/protocol/` に配置推奨。

